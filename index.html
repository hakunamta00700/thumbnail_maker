<!DOCTYPE html>
<html lang="ko" x-data="thumbnailApp()" x-init="init()">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>퀵썸네일 Canvas + DSL</title>
  <!-- Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .layout { display: flex; gap: 20px; }
    .controls, .dsl-panel { width: 300px; }
    .controls label, .dsl-panel h3 { display: block; margin-top: 10px; }
    canvas { border: 1px solid #ccc; }
    textarea, input[type="text"], select, input[type="color"] { width: 100%; margin-top: 4px; box-sizing: border-box; }
    textarea { font-family: monospace; }
    button { margin-top: 8px; padding: 6px 12px; }
  </style>
  <style x-text="fontFaceStyles()"></style>
</head>
<body>
  <h2>퀵썸네일 Canvas 미리보기 + DSL</h2>
  <div class="layout">
    <!-- Controls -->
    <div class="controls">
      <h3>설정</h3>
      <label>해상도:
        <select x-model="resolution" @change="update()">
          <option value="16:9">16:9</option>
          <option value="9:16">9:16</option>
          <option value="4:3">4:3</option>
          <option value="1:1">1:1</option>
        </select>
      </label>
      <label>배경 색상:
        <input type="color" x-model="bgColor" @input="update()">
      </label>
      <label>배경 이미지 URL:
        <input type="text" x-model="bgImageUrl" @change="update()" placeholder="URL 입력">
      </label>

      <h3>폰트 설정</h3>
      <label>Custom @font-face CSS:
        <textarea x-model="newFontCss" rows="4" placeholder="@font-face { ... }"></textarea>
      </label>
      <button @click="parseAndAddFontFace()">폰트 추가</button>

      <label>적용 폰트:
        <select x-model="fontFamily" @change="update()">
          <template x-for="f in fontFaces" :key="f.name">
            <option x-text="f.name" :value="f.name"></option>
          </template>
        </select>
      </label>

      <label>제목 텍스트:
        <textarea x-model="titleText" @input="update()"></textarea>
      </label>
      <label>제목 색상:
        <input type="color" x-model="titleColor" @input="update()">
      </label>
      <label>제목 외곽선:
        <input type="checkbox" x-model="titleOutline" @change="update()"> 적용
      </label>
      <label>부제목 텍스트:
        <textarea x-model="subtitleText" @input="update()"></textarea>
      </label>
      <label>부제목 색상:
        <input type="color" x-model="subtitleColor" @input="update()">
      </label>
      <label>부제목 표시:
        <input type="checkbox" x-model="subtitleVisible" @change="update()"> 보이기
      </label>
    </div>

    <!-- Canvas Preview -->
    <div>
      <canvas x-ref="canvas"></canvas>
    </div>

    <!-- DSL Panel -->
    <div class="dsl-panel">
      <h3>DSL (JSON)</h3>
      <textarea readonly x-text="dsl"></textarea>
    </div>
  </div>

  <script src="thumbnailRenderer.js"></script>
  <script>
    function thumbnailApp() {
      return {
        resolution: '16:9',
        bgColor: '#a3e635',
        bgImageUrl: '',
        fontFaces: [],
        newFontCss: '',
        fontFamily: '',
        titleText: '10초만에\\n썸네일 만드는 법',
        titleColor: '#4ade80',
        titleOutline: true,
        subtitleText: '쉽고 빠르게 썸네일을 만드는 법\\n= 퀵썸네일 쓰기',
        subtitleColor: '#ffffff',
        subtitleVisible: true,
        dsl: '',
        dslObj: null,
        bgImageObj: null,
        init() {
          this.fontFaces = [
            { name:'SpoqaHanSans', url:'fonts/SpoqaHanSans-Regular.woff2', weight:'normal', style:'normal' }
          ];
          this.fontFamily = this.fontFaces[0].name;
          this.update();
        },
        parseAndAddFontFace() {
          const css = this.newFontCss;
          const nameMatch = css.match(/font-family\s*:\s*['"]([^'"]+)['"]/);
          const urlMatch = css.match(/src\s*:\s*url\(['"]?([^'")]+)['"]?\)/);
          const weightMatch = css.match(/font-weight\s*:\s*(\w+)/);
          const styleMatch = css.match(/font-style\s*:\s*(\w+)/);
          if (nameMatch && urlMatch) {
            this.fontFaces.push({
              name: nameMatch[1],
              url: urlMatch[1],
              weight: weightMatch ? weightMatch[1] : 'normal',
              style: styleMatch ? styleMatch[1] : 'normal'
            });
            this.fontFamily = nameMatch[1];
            this.newFontCss = '';
            this.update();
          }
        },
        fontFaceStyles() {
          return this.fontFaces.map(f =>
            `@font-face { font-family: '${f.name}'; src: url('${f.url}') format('woff2'); font-weight: ${f.weight}; font-style: ${f.style}; }`
          ).join('\n');
        },
        update() {
          this.dsl = this.generateDSL();
          this.dslObj = JSON.parse(this.dsl);
          if (this.bgImageUrl) {
            // 이미지 비동기 로딩 후 draw
            const img = new window.Image();
            img.crossOrigin = 'anonymous';
            img.src = this.bgImageUrl;
            img.onload = () => {
              this.bgImageObj = img;
              this.draw();
            };
            img.onerror = () => {
              this.bgImageObj = null;
              this.draw();
            };
            // draw()는 onload에서 호출
            return;
          } else {
            this.bgImageObj = null;
            this.draw();
          }
        },
        draw() {
          const cv = this.$refs.canvas;
          const ctx = cv.getContext('2d');
          if (!this.dslObj) return;
          // 배경이 image면 직접 그림, 아니면 drawThumbnailOnCanvas 사용
          const bg = this.dslObj.Thumbnail.Background;
          if (bg.type === 'image' && this.bgImageObj) {
            // draw image background first
            const sizeMap = { '16:9':[480,270], '9:16':[270,480], '4:3':[480,360], '1:1':[360,360] };
            const [w,h] = sizeMap[this.resolution];
            cv.width = w; cv.height = h;
            ctx.clearRect(0,0,w,h);
            ctx.drawImage(this.bgImageObj, 0, 0, w, h);
            // 텍스트만 따로 그리기 위해 배경을 solid로 임시 변경
            const dslForText = JSON.parse(JSON.stringify(this.dslObj));
            dslForText.Thumbnail.Background = { type: 'solid', color: 'rgba(0,0,0,0)' };
            window.thumbnailRenderer.drawThumbnailOnCanvas(ctx, dslForText);
          } else {
            window.thumbnailRenderer.drawThumbnailOnCanvas(ctx, this.dslObj);
          }
        },
        generateDSL() {
          const bg = this.bgImageUrl ? { type:'image', imagePath:this.bgImageUrl } : { type:'solid', color:this.bgColor };
          const texts = [{ type:'title', content:this.titleText, position:{vertical:'top',horizontal:'left'}, font:{name:this.fontFamily,faces:this.fontFaces}, fontSize:48, color:this.titleColor, outline:this.titleOutline?{thickness:7,color:'#000'}:null, enabled:true }];
          if (this.subtitleVisible) texts.push({ type:'subtitle', content:this.subtitleText, position:{vertical:'bottom',horizontal:'left'}, font:{name:this.fontFamily,faces:this.fontFaces}, fontSize:24, color:this.subtitleColor, outline:null, enabled:true });
          return JSON.stringify({ Thumbnail:{ Resolution:{type:'preset',value:this.resolution}, Background:bg, Texts:texts }, TemplateMeta:{name:'',shareable:false} }, null,2);
        }
      }
    }
  </script>
</body>
</html>
