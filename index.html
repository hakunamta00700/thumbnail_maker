<!DOCTYPE html>
<html lang="ko" x-data="thumbnailApp()" x-init="init()">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>퀵썸네일 Canvas + DSL</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .canvas-wrap { border: 1px solid #ccc; background: #f8fafc; border-radius: 8px; padding: 12px; }
    textarea, input[type="text"], select, input[type="color"] { width: 100%; margin-top: 4px; box-sizing: border-box; }
    textarea { font-family: monospace; }
    .form-label { margin-top: 10px; }
    .dsl-panel textarea { min-height: 200px; }
    .canvas-wrap { display: flex; justify-content: center; align-items: center; min-height: 300px; }
  </style>
  <style x-text="fontFaceStyles()"></style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4 fw-bold text-primary">퀵썸네일 Canvas 미리보기 + DSL</h2>
    <div class="row g-4">
      <!-- Canvas Preview -->
      <div class="col-md-6">
        <div class="canvas-wrap shadow-sm bg-white">
          <canvas x-ref="canvas"></canvas>
        </div>
      </div>      
      <!-- Controls -->
      <div class="col-md-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="h5 mb-0">설정</h3>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#dslModal">DSL 보기</button>
            </div>
            <div class="mb-3">
              <label class="form-label">해상도</label>
              <select class="form-select" x-model="resolution" @change="update()">
                <option value="16:9">16:9</option>
                <option value="9:16">9:16</option>
                <option value="4:3">4:3</option>
                <option value="1:1">1:1</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">배경 색상</label>
              <input type="color" class="form-control form-control-color" x-model="bgColor" @input="update()">
            </div>
            <div class="mb-3">
              <label class="form-label">배경 이미지 URL</label>
              <input type="text" class="form-control" x-model="bgImageUrl" @change="update()" placeholder="URL 입력">
            </div>
            <h3 class="h6 mt-4">폰트 설정</h3>
            <div class="mb-3">
              <label class="form-label">Custom @font-face CSS</label>
              <textarea class="form-control" x-model="newFontCss" rows="3" placeholder="@font-face { ... }"></textarea>
              <button class="btn btn-outline-secondary btn-sm mt-2" @click="parseAndAddFontFace()">폰트 추가</button>
            </div>
            <div class="mb-3">
              <label class="form-label">적용 폰트</label>
              <select class="form-select" x-model="fontFamily" @change="update()">
                <template x-for="f in fontFaces" :key="f.name">
                  <option x-text="f.name" :value="f.name"></option>
                </template>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">제목 텍스트</label>
              <textarea class="form-control" x-model="titleText" @input="update()"></textarea>
            </div>
            <div class="row g-2 mb-3">
              <div class="col">
                <label class="form-label">제목 색상</label>
                <input type="color" class="form-control form-control-color" x-model="titleColor" @input="update()">
              </div>
              <div class="col d-flex align-items-end">
                <div class="form-check ms-2">
                  <input class="form-check-input" type="checkbox" x-model="titleOutline" @change="update()" id="titleOutlineCheck">
                  <label class="form-check-label" for="titleOutlineCheck">외곽선</label>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">부제목 텍스트</label>
              <textarea class="form-control" x-model="subtitleText" @input="update()"></textarea>
            </div>
            <div class="row g-2 mb-3">
              <div class="col">
                <label class="form-label">부제목 색상</label>
                <input type="color" class="form-control form-control-color" x-model="subtitleColor" @input="update()">
              </div>
              <div class="col d-flex align-items-end">
                <div class="form-check ms-2">
                  <input class="form-check-input" type="checkbox" x-model="subtitleVisible" @change="update()" id="subtitleVisibleCheck">
                  <label class="form-check-label" for="subtitleVisibleCheck">부제목 표시</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- DSL Modal -->
  <div class="modal fade" id="dslModal" tabindex="-1" aria-labelledby="dslModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dslModalLabel">DSL (JSON)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <textarea class="form-control" readonly x-text="dsl" style="min-height:300px"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS (for modal, etc. if needed) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="thumbnailRenderer.js"></script>
  <script>
    function thumbnailApp() {
      return {
        resolution: '16:9',
        bgColor: '#a3e635',
        bgImageUrl: '',
        fontFaces: [],
        newFontCss: '',
        fontFamily: '',
        titleText: '10초만에\n썸네일 만드는 법',
        titleColor: '#4ade80',
        titleOutline: true,
        subtitleText: '쉽고 빠르게 썸네일을 만드는 법\n= 퀵썸네일 쓰기',
        subtitleColor: '#ffffff',
        subtitleVisible: true,
        dsl: '',
        dslObj: null,
        bgImageObj: null,
        init() {
          this.fontFaces = [
            { name:'SpoqaHanSans', url:'fonts/SpoqaHanSans-Regular.woff2', weight:'normal', style:'normal' }
          ];
          this.fontFamily = this.fontFaces[0].name;
          this.update();
        },
        parseAndAddFontFace() {
          const css = this.newFontCss;
          const nameMatch = css.match(/font-family\s*:\s*['"]([^'"]+)['"]/);
          const urlMatch = css.match(/src\s*:\s*url\(['"]?([^'")]+)['"]?\)/);
          const weightMatch = css.match(/font-weight\s*:\s*(\w+)/);
          const styleMatch = css.match(/font-style\s*:\s*(\w+)/);
          if (nameMatch && urlMatch) {
            this.fontFaces.push({
              name: nameMatch[1],
              url: urlMatch[1],
              weight: weightMatch ? weightMatch[1] : 'normal',
              style: styleMatch ? styleMatch[1] : 'normal'
            });
            this.fontFamily = nameMatch[1];
            this.newFontCss = '';
            this.update();
          }
        },
        fontFaceStyles() {
          return this.fontFaces.map(f =>
            `@font-face { font-family: '${f.name}'; src: url('${f.url}') format('woff2'); font-weight: ${f.weight}; font-style: ${f.style}; }`
          ).join('\n');
        },
        update() {
          this.dsl = this.generateDSL();
          this.dslObj = JSON.parse(this.dsl);
          if (this.bgImageUrl) {
            // 이미지 비동기 로딩 후 draw
            const img = new window.Image();
            img.crossOrigin = 'anonymous';
            img.src = this.bgImageUrl;
            img.onload = () => {
              this.bgImageObj = img;
              this.draw();
            };
            img.onerror = () => {
              this.bgImageObj = null;
              this.draw();
            };
            // draw()는 onload에서 호출
            return;
          } else {
            this.bgImageObj = null;
            this.draw();
          }
        },
        draw() {
          const cv = this.$refs.canvas;
          const ctx = cv.getContext('2d');
          if (!this.dslObj) return;
          // 배경이 image면 직접 그림, 아니면 drawOnCanvas 사용
          const bg = this.dslObj.Thumbnail.Background;
          if (bg.type === 'image' && this.bgImageObj) {
            // draw image background first
            const sizeMap = { '16:9':[480,270], '9:16':[270,480], '4:3':[480,360], '1:1':[360,360] };
            const [w,h] = sizeMap[this.resolution];
            cv.width = w; cv.height = h;
            ctx.clearRect(0,0,w,h);
            ctx.drawImage(this.bgImageObj, 0, 0, w, h);
            // 텍스트만 따로 그리기 위해 배경을 solid로 임시 변경
            const dslForText = JSON.parse(JSON.stringify(this.dslObj));
            dslForText.Thumbnail.Background = { type: 'solid', color: 'rgba(0,0,0,0)' };
            window.thumbnailRenderer.ThumbnailRenderer.drawOnCanvas(ctx, dslForText);
          } else {
            window.thumbnailRenderer.ThumbnailRenderer.drawOnCanvas(ctx, this.dslObj);
          }
        },
        generateDSL() {
          const bg = this.bgImageUrl ? { type:'image', imagePath:this.bgImageUrl } : { type:'solid', color:this.bgColor };
          const texts = [{ type:'title', content:this.titleText, position:{vertical:'top',horizontal:'left'}, font:{name:this.fontFamily,faces:this.fontFaces}, fontSize:48, color:this.titleColor, outline:this.titleOutline?{thickness:7,color:'#000'}:null, enabled:true }];
          if (this.subtitleVisible) texts.push({ type:'subtitle', content:this.subtitleText, position:{vertical:'bottom',horizontal:'left'}, font:{name:this.fontFamily,faces:this.fontFaces}, fontSize:24, color:this.subtitleColor, outline:null, enabled:true });
          return JSON.stringify({ Thumbnail:{ Resolution:{type:'preset',value:this.resolution}, Background:bg, Texts:texts }, TemplateMeta:{name:'',shareable:false} }, null,2);
        }
      }
    }
  </script>
</body>
</html>
